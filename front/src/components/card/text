import { Card, ICharacterLvL } from '.';
import { IInventory } from '../inventory';
import axios from "axios";
import { useQuery, useQueryClient } from "react-query";


const fetchCharacters = async () => {
    const response = await axios.get("http://localhost:3001/characters");
    return response.data.data;
};

const fetchInventories = async (characterData: Array<ICharacterLvL>) => {
    const inventories: Map<string, IInventory> = new Map();
    for (let i = 0; i < characterData.length; i++) {
        // const response = await axios.get("http://localhost:3001/characters/resources", {
        //     params: characterData[i]
        // });
        // const response = await axios.get("http://localhost:3001/characters/resources", {
        //     params: {
        //         "id": "albedo",
        //         "startLvL": 3,
        //         "startIsAscended": false,
        //         "endLvL": 20,
        //         "endIsAscended": true
        //     }
        // })
        const response = await axios.get("http://localhost:3001/characters/resources", {
            params: {
                "id": characterData[i].id,
                "startLvL": characterData[i].startLvL,
                "startIsAscended": characterData[i].startIsAscended,
                "endLvL": characterData[i].endLvL,
                "endIsAscended": characterData[i].endIsAscended
            }
        })
        console.log(response.data.data);
        inventories.set(characterData[i].id, response.data.data);
    }
    return inventories;
};

const CardListContainer = () => {
    const { data: characterData, isLoading: characterIsLoading, isError: characterIsError } =
        useQuery<Array<ICharacterLvL>>('characters', fetchCharacters);
    const { data: inventoryData, isLoading: inventoryIsLoading, isError: inventoryIsError } =
        useQuery<Map<string, IInventory>>(
            'inventories',
            () => fetchInventories(characterData as Array<ICharacterLvL>),
            {
                enabled: !!characterData
            }
        );

    return (
        <div>
            {characterIsLoading || inventoryIsLoading ? (
                <span>Loading...</span>
            ) : characterData && inventoryData ? (
                <div>
                    {characterData.map((character) => (
                        <Card
                            key={character.id}
                            id={character.id}
                            name={character.id}
                            inventory={inventoryData.get(character.id) as IInventory}
                        />
                    ))}
                </div>
            ) : (
                <span>Error</span>
            )}
        </div>
    );
};

export default CardListContainer;
